<!DOCTYPE html>
<html lang="zh-cn">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
  
  <title>执手对影成双 - 运行 Utterances 的详细教程</title>
  
  <meta name="baidu-site-verification" content="NhzrvyU0CD" />
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154705931-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-154705931-1');
  </script>

  
  <meta property="og:title" content="执手对影成双 - 运行 Utterances 的详细教程">
  
  <meta property="og:type" content="website">
  <meta name="keywords" content="个人网站,博客">
  <script>
      console.info("\n%c 🎉 Hi~ 想看源代码？ %c by zsdycs %c \nGitHub仓库: https://github.com/zsdycs/lipk.org \n%c自主%c、%c跨界%c、%c终身学习%c。",
      "color: #fff; padding: 5px 0; background: #29c75f; margin: 1em 0;",
      "padding: 5px 0; background: #666666; margin: 1em 0;",
      "display: block;margin-left: 0.5em; margin: 1em 0;",
      "color:#E24432; font-size: 16px; margin: 1em 0;",
      "color:#666666; font-size: 16px; margin: 1em 0;",
      "color:#0E70ED; font-size: 16px; margin: 1em 0;",
      "color:#666666; font-size: 16px; margin: 1em 0;",
      "color:#009E5E; font-size: 16px; margin: 1em 0;",
      "color:#666666; font-size: 16px; margin: 1em 0;");
  </script>
  
  
  

  
  
  <meta property="description" content="应 @aixiu 需要本教程，本文将从 Utterances 是如何工作的；如何在本地及生产环境运行；身份授权 oauth 代码配置及运行。 这 3 个方面进行讲解。同理，本文适用于 Beaudar(表达)
[&amp;hellip;] Utterances（下面简称“UT”）有两份代码，一份是提供 client.js 的前端代码，一份是用于身份授权的“后端”代码。
我们知道 UT 是这样使用的： &amp;hellip;">
  <meta property="og:description" content="应 @aixiu 需要本教程，本文将从 Utterances 是如何工作的；如何在本地及生产环境运行；身份授权 oauth 代码配置及运行。 这 3 个方面进行讲解。同理，本文适用于 Beaudar(表达)
[&amp;hellip;] Utterances（下面简称“UT”）有两份代码，一份是提供 client.js 的前端代码，一份是用于身份授权的“后端”代码。
我们知道 UT 是这样使用的： &amp;hellip;">
  
  

  
  



<link id="highlightjsThemeDay"
    href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/github.min.css'
    rel='stylesheet' type='text/css' />
<link id="highlightjsThemeNight"
    href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/styles/vs2015.min.css'
    rel='stylesheet' type='text/css' />
<script src='//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js'>
</script>


  <link rel="icon" type="image/x-icon" href="/zsdycs_favicon.ico">
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/fonts.css" />
  <script async src="/js/load-typekit.js"></script>
<script src="/js/get-url-relative-path.js"></script>
<link rel="stylesheet" href="/css/custom.css" />
<link rel="stylesheet" href="/css/loading.css" />
<link rel="stylesheet" id="darkmodeCSS" href="/css/darkmode.css" />

</head>



<body class="blog">

  <main class="paramount">
    
    <header class="masthead">
      <nav class="menu">
  <ul>
    
    
    <li><a href="/">返回</a></li>
      
    <li><a href="/blog/">博客</a></li>
      
    <li><a href="/food/">美食</a></li>
      
      <li><a id="darkmodeTag"></a></li>
      





<li>
  <a href="http://github.com/zsdycs/lipk.org/edit/master/content/blog/2020-06-08-Run-utterances.md" title="编辑本页"
    target="_blank">
    编辑
  </a>
</li>
<li>
  <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" title="版权声明" target="_blank">
    版权
  </a>
</li>



  </ul>
</nav>
    </header>
    <article class="main">
      
      <header class="title">
        

<h1>运行 Utterances 的详细教程</h1>

<h3>
     
    李鹏坤 / 2020-06-08
</h3>
<hr>


      </header>

    


<blockquote>
<p>应 <a href="https://github.com/aixiu">@aixiu</a> 需要本教程，本文将从 Utterances 是如何工作的；如何在本地及生产环境运行；身份授权 oauth 代码配置及运行。
这 3 个方面进行讲解。同理，本文适用于 <a href="http://beaudar.lipk.org">Beaudar(表达)</a></p>
</blockquote>
<h2 id="utterances-是如何工作的">Utterances 是如何工作的</h2>
<p>Utterances（下面简称“UT”）有两份代码，一份是提供 client.js 的前端代码，一份是用于身份授权的“后端”代码。</p>
<p>我们知道 UT 是这样使用的：</p>
<pre><code class="language-html">&lt;script src=&quot;https://utteranc.es/client.js&quot;
        repo=&quot;[ENTER REPO HERE]&quot;
        issue-term=&quot;pathname&quot;
        theme=&quot;github-light&quot;
        crossorigin=&quot;anonymous&quot;
        async&gt;
&lt;/script&gt;
</code></pre>
<p>这里是在请求 client.js，然后我们可以通过浏览器控制台或源代码可以看出，client.js 会去请求 <code>api.github.com</code> 和 <code>api.utteranc.es</code>。
请求 <code>api.github.com</code> 是获得 issue 的内容，这个是公开的，无需授权。而 <code>api.utteranc.es</code> 是第二份代码实现的，用于授权登录和评论，是前端代码与 GitHub 身份认证的桥梁。</p>
<p>登录和评论的实现。在登录时，会通过请求 <code>api.utteranc.es</code> 然后跳转到 UT 的 GitHub App 进行授权，登录后“后端”代码会返回一个 token。当用户进行评论时，前端会拿着这个 token 去请求 <code>api.github.com</code>，这时，UT 会通过指定的用户 <a href="https://github.com/utterances-bot">utterances-bot</a> 创建 issue。</p>
<p>这样下来，我们知道，除了要有 <a href="https://github.com/utterance/utterances">utterance/utterances</a> 和 <a href="https://github.com/utterance/utterances-oauth">utterance/utterances-oauth</a> 这两份代码，还要有一个 GitHub app 和一个用于创建 issue 的用户。</p>
<h2 id="如何在本地及生产环境运行">如何在本地及生产环境运行</h2>
<h3 id="本地运行调试">本地运行调试</h3>
<p>基本的操作可以参考 <a href="https://github.com/utterance/utterances/blob/master/CONTRIBUTING.md">UT 的贡献文档</a> 或翻译后的 <a href="https://github.com/beaudar/beaudar/blob/master/CONTRIBUTING.MD">Beaudar 的贡献文档</a>。</p>
<p>关于 host 重定向的操作可以在 <a href="https://lipk.org/blog/2020/06/08/beauder-qa/">这个帮助文档</a>，找到设置的手顺。</p>
<p>在本地运行的时候，如果你在本地运行引用 UT 的站点，也是可以通过请求 <code>http://localhost:4000/client.js</code> 使用的。因为 UT 的后端，“ORIGINS” 来源设置了允许来自本地的请求。</p>
<h3 id="生产环境部署">生产环境部署</h3>
<p>UT 是基于 node 的，在 package.json 中，有关于部署的命令，predeploy（预部署）与 deploy（部署），可以看出，生产环境使用的是 <code>/dist</code> 文件夹下的文件。
在预部署时是在 build（构建/编译）代码，并生成 <code>/dist/CNAME</code> 文件，CNAME 是将站点托管到 GitHub 绑定自定义域名的必须文件，详情可到 <a href="https://help.github.com/cn/github/working-with-github-pages/configuring-a-custom-domain-for-your-github-pages-site">github 自定义域</a>。</p>
<p>部署时是在使用 <a href="https://www.npmjs.com/package/gh-pages">gh-pages</a> 这个插件，将 <code>/dist</code> 的内容 push 到 gh-pages 分支，为什么要放到这个奇怪的分支下？可以在 <a href="https://help.github.com/cn/github/working-with-github-pages/configuring-a-publishing-source-for-your-github-pages-site">github 配置发布源</a>，得到解答，你完全可以配置 <a href="https://parceljs.org/">parcel</a> 将默认的打包输出文件夹 <code>/dist</code> 改为 <code>/docs</code>，使用 <code>/docs</code> 下的文件作为发布源。</p>
<h2 id="身份授权代码的配置及运行">身份授权代码的配置及运行</h2>
<p><a href="https://github.com/utterance/utterances-oauth">utterance/utterances-oauth</a> 这份代码使用的是该作者维护的 <a href="https://github.com/cfworker/cfworker">cfworker</a>，在查看该库的资料时看到了<a href="https://github.com/cfworker/cfworker/issues/31">一个有趣的 issue</a>，让我对 <a href="https://deno.land/">Deno</a> 的未来增加期待了。</p>
<h3 id="配置与运行">配置与运行</h3>
<p>我们需要在根目录建立一个 <code>.env</code> 文件，具体说明可以在 <a href="https://github.com/beaudar/beaudar-oauth">beaudar-oauth 的说明文档</a> 查看。
在本地运行可能会出错，需要在 sh 下运行。可以用 git 自带的 sh。如果你已经安装了 git，只要将 <code>C:\Program Files\Git\bin</code> 添加到环境变量，命令行执行 <code>sh</code>，就可进入 sh，这时可以直接执行 <code>cfworker run --watch --inspect src/index.ts</code> 来启动程序。</p>
<p>其实这份代码不需要在本地调试，我们只需要将 build 后的 <code>src/index.ts</code> 放到 <a href="http://cloudflare.com">cloudflare</a> 的 worker 中就可以了。</p>
<p>需要用到 <a href="http://cloudflare.com">cloudflare</a> 也就是说，你需要申请一个域名了。添加 worker 的具体操作就不详细说明了，只需要配置一个运行的路由，Beaudar 使用的路由是 <code>api.lipk.org</code>，worker 名称是 beaudar。</p>

      <footer>
      
  
  <div id="eof">
    <span>EOF</span>
  </div>
  
<nav class="post-nav">
  <span class="nav-prev">&larr; <a href="/blog/2020/05/31/how-to-use-beaudar/" title="你可以使用方向键">使用评论插件 Beaudar</a></span>
  <span class="nav-next"><a href="/blog/2020/06/08/beauder-qa/" title="你可以使用方向键">关于 Beaudar 的 Q&amp;A</a> &rarr;</span>
</nav>
<script type="text/javascript">
document.addEventListener('keyup', function(e) {
  if (e.target.nodeName.toUpperCase() != 'BODY') return;
  var url = false;
  if (e.which == 37) {  
    
    url = '\/blog\/2020\/05\/31\/how-to-use-beaudar\/';
    
  } else if (e.which == 39) {  
    
    url = '\/blog\/2020\/06\/08\/beauder-qa\/';
    
  }
  if (url) window.location = url;
});
</script>



<section id="beaudar" class="comments">
  <div id="loading">
    <div class="container animation-2">
      <div class="shape shape1"></div>
      <div class="shape shape2"></div>
      <div class="shape shape3"></div>
      <div class="shape shape4"></div>
    </div>
  </div>
</section>


<script async src="/js/indentation-p.js"></script>

<script async src="/js/darkmode.js"></script>

<script async src="/js/beaudar.js"></script>

<script async src="/js/fix-toc.js"></script>

<script async src="/js/math-code.js"></script>

<script async src="/js/center-img.js"></script>

<script async src="/js/right-quote.js"></script>

<script async src="/js/no-highlight.js"></script>

<script async src="/js/fix-footnote.js"></script>

<script async src="/js/external-link.js"></script>

<script async src="/js/alt-title.js"></script>






<script async src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.0/highlight.min.js"></script>



<script>hljs.configure({ languages: [] }); hljs.initHighlightingOnLoad();</script>





      
      <hr>
      <div class="copyright">
        <span class="slogan">执手相看，对影成双</span>
        © 2018 - 2020 <a href="/">执手对影成双</a>
        <a href="https://travellings.now.sh/" target="blank" title="开往-友链接力">
          <img src="/images/travellings.svg" alt="开往-友链接力" height="23" style="vertical-align: text-top;">
        </a>
      </div>
      
      </footer>
  
    </article>
  </main>
  
</body>
</html>
